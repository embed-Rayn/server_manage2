서버 설치, 관련 패키지&드라이버 설치

# 1. 서버: Ubuntu 24.04 설치 in 폐쇄망


1. 사전 확인: nvidia-container-runtime이 [nvidia-container-runtime](https://nvidia.github.io/nvidia-container-runtime/) [container-toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/supported-platforms.html)
  - 26.01.16 기준: nvidia-container-runtime는 22.04, container-toolkit는 24.04까지 지원
---

# 2. 다운로드 환경 설정
1. WSL 실행
2. wsl 위에 24.04 실행
  - `sudo docker run -it --name ubuntu_2404 -v /mnt/c/offline_pkgs/ubuntu24:/offline ubuntu:24.04`
# 2. 도커 설치
## repo 설정
```bash
# Add Docker's official GPG key:
mkdir -p /offline/docker2404
cd /offline/docker2404
apt update
apt-get install --download-only --reinstall --no-install-recommends \
  -o Dir::Cache::Archives=/offline/docker2404 \
  ca-certificates curl wget
apt download ca-certificates curl wget

apt install -y ca-certificates curl wget software-properties-common
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  tee /etc/apt/sources.list.d/docker.list > /dev/null
apt-get update

apt-get install -y --download-only --reinstall --no-install-recommends \
  -o Dir::Cache::Archives=/offline/docker2404 \
  docker-ce \
  docker-ce-cli \
  containerd.io \
  docker-buildx-plugin \
  docker-compose-plugin

apt download docker-ce docker-ce-cli containerd.io \
  docker-buildx-plugin docker-compose-plugin

# sudo apt-get -f install # 설치 안 되면 이렇게
```

---
# 3. CUDA 설치([우분투24.04 CUDA13.0.2](https://developer.nvidia.com/cuda-13-0-2-download-archive?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=24.04&target_type=deb_local))
- CUDA 패키지 준비: pin 파일 다운로드 및 이동, CUDA 데비안 패키지 다운로드 후 설치
- 키링 복사: 설치된 CUDA 키링 파일을 시스템 키링 디렉토리로 이동
- 패키지 설치: apt-get 업데이트 후 cuda-toolkit-12-6 설치
- 환경 변수 설정: PATH와 LD_LIBRARY_PATH가 bashrc에 추가되어 영구 반영
```bash
mkdir -p /offline/cuda2404
cd /offline/cuda2404
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-ubuntu2404.pin
mv cuda-ubuntu2404.pin /etc/apt/preferences.d/cuda-repository-pin-600
wget https://developer.download.nvidia.com/compute/cuda/13.0.2/local_installers/cuda-repo-ubuntu2404-13-0-local_13.0.2-580.95.05-1_amd64.deb
dpkg -i cuda-repo-ubuntu2404-13-0-local_13.0.2-580.95.05-1_amd64.deb
cp /var/cuda-repo-ubuntu2404-13-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
apt-get update
apt-get install -y --download-only --reinstall --no-install-recommends \
  -o Dir::Cache::Archives=/offline/cuda2404 \
  cuda-toolkit-13-0
apt download cuda-toolkit-13-0
```



---
# 4. NVIDIA Container Toolkit
## repo 설정
```bash
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
sed -i -e '/experimental/ s/^#//g' /etc/apt/sources.list.d/nvidia-container-toolkit.list
apt-get update
```


## nvidia-smi 580 설치
```bash
apt-get install -y nvidia-open
apt-get install -y --download-only --reinstall --no-install-recommends \
  -o Dir::Cache::Archives=/offline/nvidia2404 \
  nvidia-open
apt download nvidia-open
# sudo apt install -y nvidia-driver-580
# sudo ubuntu-drivers autoinstall
```
---
# 5. 이관 전 압축/ 이관 후 압축 해제
1. 이관 전 압축
```bash
cd /
tar -cvzf 2404_offline.tar.gz offline/
```

2. 컨테이너 종료 후 파일 SSD 로 옮기기
3. 폐쇄망 서버로 이전

```bash
tar -xvzf 2404_offline.tar.gz ~/offline_pkgs/
```
## 컨테이너 설치

`apt install -y software-properties-common`
```bash
mkdir /offline/nvidia2404/container
cd /offline/nvidia2404/container
add-apt-repository ppa:graphics-drivers/ppa
apt-get install -y --download-only --reinstall --no-install-recommends \
  -o Dir::Cache::Archives=/offline/nvidia2404/container \
  nvidia-container-toolkit
apt download nvidia-container-toolkit
apt-get install -y nvidia-container-toolkit
```

## 도커 삭제
```bash
for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do apt-get remove $pkg; done
```

## 도커 설정
```bash
sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker
sudo mkdir -p /workspace/8888 /workspace/8889
sudo chown -R $USER:$USER /workspace
```

```bash
echo "export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}" >> "$HOME/.bashrc"
echo "export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}" >> "$HOME/.bashrc"
export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}
export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
```

## NVML 에러 수정
#nvidia-smi<br>
Failed to initialize NVML: Unknown Error
```bash
sudo vim /etc/nvidia-container-runtime/config.toml
```
```toml
...
no-cgroups = false # 주석 해제
...
```

or/and
```bash
sudo vim /etc/docker/daemon.json 
```
```json
{  
   "runtimes": {  
       "nvidia": {  
           "args": [],  
           "path": "nvidia-container-runtime"  
       }  
   },  
   "exec-opts": ["native.cgroupdriver=cgroupfs"] # 추가
} 
```
재부팅
```
sudo shutdown -r now
```


---
### GB01: DNS 설정 초기화로 인터넷 연결 에러
```bash
sudo mkdir -p /etc/systemd/resolved.conf.d
sudo vim /etc/systemd/resolved.conf.d/dns_servers.conf
```
`dns_servers.conf`
```conf
[Resolve]
DNS=8.8.8.8 8.8.4.4
FallbackDNS=1.1.1.1
```

```bash
sudo systemctl restart systemd-resolved
ls -l /etc/resolv.conf
#결과 /etc/resolv.conf -> ../run/systemd/resolve/stub-resolv.conf
```
